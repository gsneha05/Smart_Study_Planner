<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Smart Study Planner</title>
  <style>
    :root{--bg:#0f1724;--card:#0b1220;--muted:#9aa4b2;--accent:#7c5cff;--success:#22c55e}
    *{box-sizing:border-box;font-family:Inter,system-ui,Segoe UI,Roboto,'Helvetica Neue',Arial}
    body{margin:0;min-height:100vh;background:linear-gradient(180deg,#071025 0%,#071129 60%);color:#e6eef6}
    .container{max-width:1100px;margin:32px auto;padding:20px}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px}
    h1{font-size:20px;margin:0}
    .sub{color:var(--muted);font-size:13px}

    .grid{display:grid;grid-template-columns:360px 1fr;gap:18px}

    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:16px;border-radius:12px;box-shadow:0 6px 18px rgba(2,6,23,0.6)}
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
    input[type='text'], textarea, input[type='datetime-local'], select{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit}
    textarea{min-height:80px;resize:vertical}
    .row{display:flex;gap:8px}
    .btn{display:inline-block;padding:10px 12px;border-radius:10px;background:var(--accent);border:none;color:white;cursor:pointer}
    .btn.secondary{background:transparent;border:1px solid rgba(255,255,255,0.06)}

    /* task list */
    .task-list{display:flex;flex-direction:column;gap:10px;margin-top:12px}
    .task{display:flex;align-items:flex-start;gap:12px;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.02);background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00))}
    .dot{width:10px;height:10px;border-radius:50%}
    .task-body{flex:1}
    .task-title{font-weight:600}
    .meta{font-size:12px;color:var(--muted);margin-top:6px}
    .task-actions{display:flex;flex-direction:column;gap:6px}
    .small{font-size:12px;padding:8px;border-radius:8px}

    /* timeline */
    .timeline{margin-top:12px;padding:16px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.008), rgba(255,255,255,0.006));min-height:220px}
    .timeline-row{display:flex;gap:10px;align-items:center;margin-bottom:10px}
    .timeline-time{width:110px;font-size:13px;color:var(--muted)}
    .timeline-bar{flex:1;height:22px;border-radius:12px;background:rgba(255,255,255,0.02);position:relative}
    .timeline-item{position:absolute;top:2px;height:18px;border-radius:10px;display:flex;align-items:center;padding:0 8px;font-size:12px;color:#071129}

    /* responsive */
    @media (max-width:880px){.grid{grid-template-columns:1fr;}.timeline-time{width:90px}}

    /* footer */
    footer{margin-top:20px;color:var(--muted);font-size:13px}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <h1>Smart Study Planner</h1>
        <div class="sub"></div>
      </div>
      <div>
        <button id="notify-perm" class="btn secondary">Enable Notifications</button>
      </div>
    </header>

    <div class="grid">
      <div>
        <div class="card">
          <h3 style="margin-top:0">Add / Edit Task</h3>
          <input type="hidden" id="task-id" />
          <label>Title</label>
          <input id="title" type="text" placeholder="e.g. Revise DS chapter 3" />
          <label style="margin-top:10px">Description</label>
          <textarea id="desc" placeholder="Notes, topics to cover..."></textarea>
          <div style="display:flex;gap:8px;margin-top:8px">
            <div style="flex:1">
              <label>Due date & time</label>
              <input id="due" type="datetime-local" />
            </div>
            <div style="width:120px">
              <label>Priority</label>
              <select id="priority">
                <option value="low">Low</option>
                <option value="medium" selected>Medium</option>
                <option value="high">High</option>
              </select>
            </div>
          </div>
          <div style="display:flex;gap:8px;margin-top:10px;align-items:center">
            <div style="flex:1">
              <label>Estimated duration (mins)</label>
              <input id="duration" type="text" placeholder="e.g. 45" />
            </div>
            <div style="width:120px">
              <label>Reminder (mins before)</label>
              <input id="reminder" type="text" placeholder="e.g. 15" />
            </div>
          </div>

          <div style="display:flex;gap:8px;margin-top:12px">
            <button id="save-btn" class="btn">Save Task</button>
            <button id="clear-btn" class="btn secondary">Clear</button>
            <button id="export-btn" class="btn secondary">Export JSON</button>
            <button id="import-btn" class="btn secondary">Import</button>
            <input id="import-file" type="file" accept="application/json" style="display:none" />
          </div>

          <div style="margin-top:12px">
            <label>Quick add (title | due in mins) — press Enter</label>
            <input id="quick" type="text" placeholder="Example: Read paper | 120" />
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <h3 style="margin-top:0">Filters & Bulk</h3>
          <div style="display:flex;gap:8px;margin-top:8px">
            <select id="filter-priority"><option value="all">All priorities</option><option value="high">High</option><option value="medium">Medium</option><option value="low">Low</option></select>
            <select id="filter-status"><option value="all">All status</option><option value="pending">Pending</option><option value="done">Done</option></select>
            <input id="search" type="text" placeholder="Search title or desc" />
          </div>
          <div style="margin-top:10px;display:flex;gap:8px">
            <button id="clear-done" class="btn secondary">Clear Completed</button>
            <button id="reset-all" class="btn secondary">Reset All</button>
          </div>
        </div>
      </div>

      <div>
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <h3 style="margin:0">Tasks</h3>
            <div class="sub"></div>
          </div>

          <div style="margin-top:12px;display:flex;gap:8px;align-items:center">
            <button id="view-list" class="btn small">List</button>
            <button id="view-timeline" class="btn small secondary">Timeline</button>
            <div style="flex:1"></div>
            <div class="sub"><code></code></div>
          </div>

          <div id="main-area">
            <div id="list-view">
              <div class="task-list" id="tasks"></div>
            </div>
            <div id="timeline-view" style="display:none">
              <div class="timeline" id="timeline"></div>
            </div>
          </div>

        </div>

        <footer>
          
        </footer>
      </div>
    </div>
  </div>

  <script>
    // Utilities
    const uid = () => Date.now().toString(36)+Math.random().toString(36).slice(2,7)
    const STORAGE_KEY = 'smart-planner-v1'

    // Elements
    const el = id=>document.getElementById(id)
    const title = el('title'), desc = el('desc'), due = el('due'), priority = el('priority'), duration = el('duration'), reminder = el('reminder'), saveBtn = el('save-btn'), clearBtn = el('clear-btn'), tasksWrap = el('tasks'), taskId = el('task-id'), quick = el('quick')
    const notifyPermBtn = el('notify-perm')
    const viewListBtn = el('view-list'), viewTimelineBtn = el('view-timeline'), timelineWrap = el('timeline'), listView = el('list-view'), timelineView = el('timeline-view')
    const exportBtn = el('export-btn'), importBtn = el('import-btn'), importFile = el('import-file')
    const filterPriority = el('filter-priority'), filterStatus = el('filter-status'), searchInp = el('search'), clearDoneBtn = el('clear-done'), resetAllBtn = el('reset-all')

    let tasks = []

    function load(){
      try{tasks = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]')}catch(e){tasks=[]}
      render()
    }

    function save(){
      localStorage.setItem(STORAGE_KEY, JSON.stringify(tasks))
      render()
    }

    function render(){
      // Apply filters
      const pFilter = filterPriority.value
      const sFilter = filterStatus.value
      const q = searchInp.value.trim().toLowerCase()
      const visible = tasks.slice().sort((a,b)=>new Date(a.due||0)-new Date(b.due||0)).filter(t=>{
        if(pFilter!=='all' && t.priority!==pFilter) return false
        if(sFilter!=='all' && ((t.done? 'done':'pending')!==sFilter)) return false
        if(q){return (t.title||'').toLowerCase().includes(q) || (t.desc||'').toLowerCase().includes(q)}
        return true
      })

      // list
      tasksWrap.innerHTML = ''
      if(visible.length===0){tasksWrap.innerHTML = '<div class="sub" style="padding:12px">No tasks yet — add your first study session.</div>'}
      visible.forEach(t=>{
        const row = document.createElement('div'); row.className='task'
        const dot = document.createElement('div'); dot.className='dot'; dot.style.background = t.done? 'linear-gradient(90deg,#a7f3d0,#6ee7b7)':'#7c5cff'
        const body = document.createElement('div'); body.className='task-body'
        const titleEl = document.createElement('div'); titleEl.className='task-title'; titleEl.textContent = t.title || '(No title)'
        const meta = document.createElement('div'); meta.className='meta'
        const dueText = t.due? new Date(t.due).toLocaleString(): 'No due'
        meta.textContent = `${dueText} • ${t.priority} • ${t.duration? t.duration+' mins':''}`
        const descEl = document.createElement('div'); descEl.className='meta'; descEl.style.marginTop='6px'; descEl.textContent = t.desc||''
        body.appendChild(titleEl); body.appendChild(meta); if(t.desc) body.appendChild(descEl)

        const actions = document.createElement('div'); actions.className='task-actions'
        const doneBtn = document.createElement('button'); doneBtn.className='small'; doneBtn.textContent = t.done? 'Mark Pending':'Mark Done'
        doneBtn.addEventListener('click', (e)=>{e.stopPropagation(); t.done = !t.done; save();})
        const editBtn = document.createElement('button'); editBtn.className='small'; editBtn.textContent='Edit'
        editBtn.addEventListener('click',(e)=>{e.stopPropagation(); openEdit(t.id)})
        const delBtn = document.createElement('button'); delBtn.className='small'; delBtn.textContent='Delete'
        delBtn.addEventListener('click',(e)=>{e.stopPropagation(); if(confirm('Delete this task?')){tasks = tasks.filter(x=>x.id!==t.id); save()}})
        actions.appendChild(doneBtn); actions.appendChild(editBtn); actions.appendChild(delBtn)

        row.appendChild(dot); row.appendChild(body); row.appendChild(actions)
        row.addEventListener('click', ()=>openEdit(t.id))
        tasksWrap.appendChild(row)
      })

      // timeline
      timelineWrap.innerHTML = ''
      const upcoming = tasks.slice().filter(t=>t.due).sort((a,b)=>new Date(a.due)-new Date(b.due))
      if(upcoming.length===0){timelineWrap.innerHTML = '<div class="sub">No scheduled tasks to show on timeline.</div>'}
      // timeline bar is 24 hours window from now, then greedy placement
      const now = Date.now()
      const dayMs = 1000*60*60*24
      const windowStart = now - (12*60*60*1000) // show -12h to +12h for context
      const windowEnd = now + (12*60*60*1000)
      upcoming.forEach(t=>{
        const d = new Date(t.due).getTime()
        const row = document.createElement('div'); row.className='timeline-row'
        const timeEl = document.createElement('div'); timeEl.className='timeline-time'; timeEl.textContent = new Date(t.due).toLocaleString()
        const bar = document.createElement('div'); bar.className='timeline-bar'
        const item = document.createElement('div'); item.className='timeline-item'; item.textContent = t.title
        // position
        const pct = Math.min(100, Math.max(0, (d-windowStart)/(windowEnd-windowStart)*100))
        const left = pct
        item.style.left = left+'%'
        item.style.width = Math.min(60, Math.max(80*(t.duration? t.duration/60:0.2), 40))+'px'
        item.style.background = t.done? 'rgba(34,197,94,0.9)':'#7c5cff'
        bar.appendChild(item)
        row.appendChild(timeEl); row.appendChild(bar)
        timelineWrap.appendChild(row)
      })
    }

    function openEdit(id){
      const t = tasks.find(x=>x.id===id); if(!t) return
      taskId.value = t.id; title.value=t.title||''; desc.value=t.desc||''; due.value = t.due? formatForInput(new Date(t.due)) : '';
      priority.value=t.priority||'medium'; duration.value=t.duration||''; reminder.value=t.reminder||''
      window.scrollTo({top:0,behavior:'smooth'})
    }

    function formatForInput(date){
      // returns yyyy-mm-ddThh:mm
      const pad = n=>n.toString().padStart(2,'0')
      return `${date.getFullYear()}-${pad(date.getMonth()+1)}-${pad(date.getDate())}T${pad(date.getHours())}:${pad(date.getMinutes())}`
    }

    saveBtn.addEventListener('click', ()=>{
      const id = taskId.value || uid()
      const tObj = {
        id,
        title: title.value.trim(),
        desc: desc.value.trim(),
        due: due.value? new Date(due.value).toISOString(): null,
        priority: priority.value,
        duration: duration.value? parseInt(duration.value): null,
        reminder: reminder.value? parseInt(reminder.value): null,
        done: false
      }
      // if editing, preserve done state
      const existing = tasks.find(x=>x.id===id)
      if(existing){ tObj.done = existing.done; tasks = tasks.map(x=> x.id===id? {...existing,...tObj}: x) }
      else tasks.push(tObj)
      taskId.value=''
      title.value=''; desc.value=''; due.value=''; priority.value='medium'; duration.value=''; reminder.value=''
      save();
    })

    clearBtn.addEventListener('click', ()=>{ taskId.value=''; title.value=''; desc.value=''; due.value=''; priority.value='medium'; duration.value=''; reminder.value=''; })

    quick.addEventListener('keydown', (e)=>{
      if(e.key==='Enter'){ const parts = quick.value.split('|').map(s=>s.trim()); if(parts.length>=2){ const mins = parseInt(parts[1])||60; const d = new Date(Date.now()+mins*60000); tasks.push({id:uid(), title:parts[0], desc:'', due:d.toISOString(), priority:'medium', duration:null, reminder:15, done:false}); quick.value=''; save() } }
    })

    // view toggles
    viewListBtn.addEventListener('click', ()=>{ listView.style.display='block'; timelineView.style.display='none'; viewListBtn.classList.remove('secondary'); viewTimelineBtn.classList.add('secondary') })
    viewTimelineBtn.addEventListener('click', ()=>{ listView.style.display='none'; timelineView.style.display='block'; viewTimelineBtn.classList.remove('secondary'); viewListBtn.classList.add('secondary') })

    // export / import
    exportBtn.addEventListener('click', ()=>{
      const data = JSON.stringify(tasks, null, 2)
      const blob = new Blob([data], {type:'application/json'})
      const url = URL.createObjectURL(blob)
      const a = document.createElement('a'); a.href = url; a.download = 'smart-planner-export.json'; a.click(); URL.revokeObjectURL(url)
    })
    importBtn.addEventListener('click', ()=>importFile.click())
    importFile.addEventListener('change', (e)=>{
      const f = e.target.files[0]; if(!f) return
      const reader = new FileReader(); reader.onload = ()=>{ try{ const data = JSON.parse(reader.result); if(Array.isArray(data)){ tasks = data; save(); alert('Imported '+data.length+' tasks') }else alert('Invalid JSON format') }catch(err){alert('Invalid file') } }
      reader.readAsText(f)
      importFile.value=''
    })

    // filters
    filterPriority.addEventListener('change', render); filterStatus.addEventListener('change', render); searchInp.addEventListener('input', render)

    clearDoneBtn.addEventListener('click', ()=>{ if(confirm('Remove all completed tasks?')){ tasks = tasks.filter(t=>!t.done); save() } })
    resetAllBtn.addEventListener('click', ()=>{ if(confirm('Reset and clear all tasks? This cannot be undone.')){ tasks=[]; save() } })

    // notifications
    notifyPermBtn.addEventListener('click', async ()=>{
      if(!('Notification' in window)) return alert('Notifications not supported by this browser')
      const p = await Notification.requestPermission()
      if(p==='granted') alert('Notifications enabled — reminders will show while page is open')
      else alert('Notifications denied')
    })

    // reminders checker
    function checkReminders(){
      const now = Date.now()
      tasks.forEach(t=>{
        if(!t.due) return
        if(t._notified) return
        const dueTs = new Date(t.due).getTime()
        const rem = (t.reminder||0)*60000
        const notifyAt = dueTs - rem
        // small tolerance of 1 minute
        if(now >= notifyAt && now < dueTs + 60000){
          // show notification if permission
          if(window.Notification && Notification.permission==='granted'){
            const n = new Notification(t.title || 'Study Reminder', {body: t.desc || ('Due at '+new Date(t.due).toLocaleString())})
            n.onclick = ()=>window.focus()
          }
          t._notified = true
        }
      })
    }

    // simple persistence of _notified flags by enriching saved tasks
    setInterval(()=>{ checkReminders(); save() }, 30*1000)

    // initial load
    load()

    // save before unload
    window.addEventListener('beforeunload', ()=>localStorage.setItem(STORAGE_KEY, JSON.stringify(tasks)))

  </script>
</body>
</html>
